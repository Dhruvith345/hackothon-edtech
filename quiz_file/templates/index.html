<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-light">
    <div class="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    </div>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-lg">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h1 class="mb-0">AI Quiz Generator</h1>
                        <a href="/history" class="btn btn-outline-light">Quiz History</a>
                    </div>
                    
                    <div class="card-body p-4">
                        <div id="alertContainer"></div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-8">
                                <input type="text" id="topic" class="form-control form-control-lg" 
                                       placeholder="Enter topic (e.g., Python Programming)" required>
                            </div>
                            <div class="col-md-2">
                                <input type="number" id="count" class="form-control form-control-lg" 
                                       value="10" min="1" max="50">
                            </div>
                            <div class="col-md-2">
                                <button onclick="generateQuiz()" class="btn btn-light btn-lg w-100">
                                    ðŸš€ Generate
                                </button>
                            </div>
                        </div>

                        <div id="quizContainer"></div>
                        <div id="resultSummary" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let quizData = [];

        function showLoading(show) {
            document.querySelector('.loading-overlay').style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('alertContainer').prepend(alert);
        }

        async function generateQuiz() {
            const topic = document.getElementById('topic').value.trim();
            const count = document.getElementById('count').value;
            
            if (!topic) {
                showAlert('Please enter a topic!', 'danger');
                return;
            }

            try {
                showLoading(true);
                clearUI();
                
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `topic=${encodeURIComponent(topic)}&count=${count}`
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to generate quiz');
                
                quizData = data;
                renderQuestions(data);
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function renderQuestions(questions) {
            const container = document.getElementById('quizContainer');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'card mb-3 question-card';
                questionDiv.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">
                            <span class="badge bg-primary">Q${index + 1}</span>
                            ${q.question}
                            <span class="badge ${getTypeBadgeClass(q.type)} ms-2">
                                ${q.type.toUpperCase()}
                            </span>
                        </h5>
                        <div class="answer-section mt-3">
                            ${getAnswerInput(q.type, index)}
                        </div>
                    </div>
                `;
                container.appendChild(questionDiv);
            });

            addSubmitButton();
        }

        function getAnswerInput(type, index) {
            if (type === 'tf') {
                return `
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="q${index}" 
                               id="q${index}-true" value="True">
                        <label class="btn btn-outline-success" for="q${index}-true">True</label>

                        <input type="radio" class="btn-check" name="q${index}" 
                               id="q${index}-false" value="False">
                        <label class="btn btn-outline-danger" for="q${index}-false">False</label>
                    </div>
                `;
            }
            return `
                <div class="input-group">
                    <input type="text" class="form-control answer-input" 
                           data-question-index="${index}" 
                           placeholder="Enter your answer here...">
                </div>
            `;
        }

        function checkAnswers() {
            let correctCount = 0;
            const results = [];
            const topic = document.getElementById('topic').value.trim();

            quizData.forEach((q, index) => {
                const userAnswer = getUserAnswer(q.type, index);
                const isCorrect = compareAnswers(userAnswer, q.answer);
                
                if (isCorrect) correctCount++;
                results.push({
                    question: q.question,
                    userAnswer: userAnswer || 'No answer',
                    correctAnswer: q.answer,
                    isCorrect
                });
                markQuestion(index, isCorrect);
            });

            // Save results
            fetch('/save_result', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    topic: topic,
                    score: correctCount,
                    total_questions: quizData.length,
                    results: results
                })
            });

            showResults(correctCount, results);
        }

        function getUserAnswer(type, index) {
            if (type === 'tf') {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                return selected ? selected.value : '';
            }
            return document.querySelector(`input[data-question-index="${index}"]`).value.trim();
        }

        function compareAnswers(userAnswer, correctAnswer) {
            return userAnswer.toLowerCase() === correctAnswer.toLowerCase();
        }

        function markQuestion(index, isCorrect) {
            const questionDiv = document.querySelectorAll('.question-card')[index];
            questionDiv.classList.remove('correct-answer', 'incorrect-answer');
            questionDiv.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');
        }

        function showResults(correctCount, results) {
            const total = quizData.length;
            const percentage = ((correctCount / total) * 100).toFixed(1);
            
            const resultHTML = `
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">Quiz Results</h4>
                    </div>
                    <div class="card-body">
                        <h5>Score: ${correctCount}/${total} (${percentage}%)</h5>
                        <a href="/history" class="btn btn-secondary mb-3">View History</a>
                        <div class="mt-3">
                            ${results.map((r, i) => `
                                <div class="result-item mb-3 p-3 rounded ${r.isCorrect ? 'bg-success-light' : 'bg-danger-light'}">
                                    <h6>Q${i + 1}: ${r.question}</h6>
                                    <div class="text-muted">Your answer: ${r.userAnswer}</div>
                                    <div class="text-muted">Correct answer: ${r.correctAnswer}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-warning w-100" onclick="window.location.reload()">
                            Try Again
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('resultSummary').innerHTML = resultHTML;
        }

        function addSubmitButton() {
            const container = document.getElementById('quizContainer');
            const btn = document.createElement('button');
            btn.className = 'btn btn-primary btn-lg w-100 mt-4';
            btn.textContent = 'Submit Answers';
            btn.onclick = checkAnswers;
            container.appendChild(btn);
        }

        function getTypeBadgeClass(type) {
            return {
                fill: 'bg-info',
                code: 'bg-warning text-dark',
                tf: 'bg-success'
            }[type] || 'bg-secondary';
        }

        function clearUI() {
            document.getElementById('quizContainer').innerHTML = '';
            document.getElementById('resultSummary').innerHTML = '';
            document.getElementById('alertContainer').innerHTML = '';
        }
    </script>
</body>
</html>